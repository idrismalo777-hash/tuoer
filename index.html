<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‰˜å°”æ•™è‚² Â· æ™ºèƒ½å®¢æœ</title>
    <style>
        :root{--bg:#f5f5f7;--card:#fff;--text:#1d1d1f;--text2:#6e6e73;--text3:#aeaeb2;--border:#e5e5ea;--primary:#0071e3}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        html,body{height:100%;overflow:hidden}
        body{font-family:-apple-system,BlinkMacSystemFont,'PingFang SC',sans-serif;background:var(--bg);color:var(--text)}
        
        #selectPage{height:100%;display:flex;flex-direction:column;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
        #selectPage.hidden{display:none}
        .select-header{text-align:center;padding:40px 0 30px;color:#fff}
        .select-header h1{font-size:28px;font-weight:600;margin-bottom:8px}
        .select-header p{font-size:14px;opacity:.85}
        .agent-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .agent-card{background:#fff;border-radius:16px;padding:20px 16px;text-align:center;cursor:pointer;transition:transform .2s}
        .agent-card:active{transform:scale(.96)}
        .agent-card .avatar{width:64px;height:64px;border-radius:50%;margin:0 auto 12px;display:flex;align-items:center;justify-content:center;font-size:28px;color:#fff}
        .agent-card h3{font-size:16px;font-weight:600;margin-bottom:4px}
        .agent-card .role{font-size:12px;color:var(--text2);margin-bottom:8px}
        .agent-card .desc{font-size:11px;color:var(--text3);line-height:1.5}
        .c1 .avatar{background:linear-gradient(135deg,#ff6b9d,#c44569)}
        .c2 .avatar{background:linear-gradient(135deg,#4facfe,#00f2fe)}
        .c3 .avatar{background:linear-gradient(135deg,#fa709a,#fee140)}
        .c4 .avatar{background:linear-gradient(135deg,#a8edea,#fed6e3)}
        
        #chatPage{height:100%;display:none;flex-direction:column;background:var(--bg)}
        #chatPage.show{display:flex}
        .header{padding:12px 16px;background:var(--card);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
        .back-btn{width:36px;height:36px;border-radius:50%;background:var(--bg);border:none;cursor:pointer;font-size:18px;color:var(--text2)}
        .header .avatar{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;color:#fff}
        .header .info{flex:1}
        .header .info h2{font-size:16px;font-weight:500;margin-bottom:2px}
        .header .info .sub{font-size:12px;color:var(--text2)}
        .online-dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:#34c759;margin-right:6px}
        
        #msgList{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:16px}
        .msg{display:flex;gap:10px;max-width:80%;animation:fadeIn .3s}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1}}
        .msg.user{align-self:flex-end;flex-direction:row-reverse}
        .msg .av{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;color:#fff;flex-shrink:0}
        .msg.user .av{background:var(--primary)}
        .msg .bubble{padding:12px 16px;border-radius:20px;font-size:15px;line-height:1.6;word-break:break-word;white-space:pre-wrap}
        .msg.ai .bubble{background:#fff;border-bottom-left-radius:6px}
        .msg.user .bubble{background:var(--primary);color:#fff;border-bottom-right-radius:6px}
        .msg .time{font-size:11px;color:var(--text3);margin-top:4px;padding:0 8px}
        .msg.user .time{text-align:right}
        
        #typingBox{display:none;gap:10px;max-width:80%}
        #typingBox.show{display:flex}
        #typingBox .av{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;color:#fff}
        .dots{display:flex;gap:4px;padding:14px 18px;background:#fff;border-radius:20px;border-bottom-left-radius:6px}
        .dots span{width:8px;height:8px;background:var(--text3);border-radius:50%;animation:dot 1.4s infinite}
        .dots span:nth-child(2){animation-delay:.2s}
        .dots span:nth-child(3){animation-delay:.4s}
        @keyframes dot{0%,60%,100%{transform:translateY(0);opacity:.4}30%{transform:translateY(-6px);opacity:1}}
        
        #quickBtns{padding:8px 16px;display:flex;gap:8px;overflow-x:auto}
        #quickBtns::-webkit-scrollbar{display:none}
        #quickBtns button{padding:10px 16px;background:#fff;border:1px solid var(--border);border-radius:20px;font-size:13px;white-space:nowrap;cursor:pointer}
        #quickBtns button:active{background:var(--primary);color:#fff;border-color:var(--primary)}
        
        .input-area{padding:12px 16px;padding-bottom:max(12px,env(safe-area-inset-bottom));background:var(--card);border-top:1px solid var(--border)}
        .input-row{display:flex;gap:10px;align-items:flex-end}
        .input-wrap{flex:1;background:var(--bg);border-radius:24px;padding:4px;border:1px solid var(--border)}
        textarea{width:100%;padding:10px 16px;background:transparent;border:none;font-size:16px;resize:none;max-height:100px;line-height:1.4;outline:none;font-family:inherit}
        textarea::placeholder{color:var(--text3)}
        #sendBtn{width:44px;height:44px;border-radius:50%;background:var(--primary);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center}
        #sendBtn:disabled{background:var(--border)}
        #sendBtn svg{width:20px;height:20px}
        
        #toast{position:fixed;top:80px;left:50%;transform:translateX(-50%);background:#fff;border:1px solid var(--border);border-radius:24px;padding:10px 20px;font-size:13px;color:var(--text2);display:none;align-items:center;gap:10px;z-index:99}
        #toast.show{display:flex}
        #toast .spin{width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        @media(min-width:600px){#selectPage,#chatPage{max-width:500px;margin:0 auto}}
    </style>
</head>
<body>

<div id="selectPage">
    <div class="select-header">
        <h1>ğŸ’ æ‰˜å°”æ•™è‚²</h1>
        <p>ä¸“ä¸šè¯¾åæ‰˜ç®¡ Â· è®©å­©å­å¿«ä¹æˆé•¿</p>
    </div>
    <div class="agent-grid">
        <div class="agent-card c1" onclick="openChat(0)">
            <div class="avatar">ğŸ‘©</div>
            <h3>å°ç¾è€å¸ˆ</h3>
            <div class="role">è¯¾ç¨‹é¡¾é—®</div>
            <div class="desc">çƒ­æƒ…å¼€æœ—ï¼Œä¸“ä¸šè§£ç­”è¯¾ç¨‹ã€ä»·æ ¼ã€æŠ¥åé—®é¢˜</div>
        </div>
        <div class="agent-card c2" onclick="openChat(1)">
            <div class="avatar">ğŸ‘¨</div>
            <h3>é™ˆè€å¸ˆ</h3>
            <div class="role">æ•™åŠ¡ä¸»ç®¡</div>
            <div class="desc">ä¸¥è°¨è´Ÿè´£ï¼Œå¤„ç†è¯¾ç¨‹å®‰æ’ã€è¯·å‡ã€è°ƒè¯¾é—®é¢˜</div>
        </div>
        <div class="agent-card c3" onclick="openChat(2)">
            <div class="avatar">ğŸ‘©â€ğŸ«</div>
            <h3>å°è–‡è€å¸ˆ</h3>
            <div class="role">æ‰˜ç®¡ç­ä¸»ä»»</div>
            <div class="desc">æ¸©æŸ”è€å¿ƒï¼Œåé¦ˆå­©å­æ—¥å¸¸è¡¨ç°ã€å­¦ä¹ æƒ…å†µ</div>
        </div>
        <div class="agent-card c4" onclick="openChat(3)">
            <div class="avatar">ğŸ§‘â€ğŸ’¼</div>
            <h3>æ¨ä¸»ä»»</h3>
            <div class="role">æ ¡åŒºè´Ÿè´£äºº</div>
            <div class="desc">ç»éªŒä¸°å¯Œï¼Œå¤„ç†æŠ•è¯‰å»ºè®®ã€ç‰¹æ®Šéœ€æ±‚</div>
        </div>
    </div>
</div>

<div id="chatPage">
    <div class="header">
        <button class="back-btn" onclick="goBack()">â†</button>
        <div class="avatar" id="hAvatar"></div>
        <div class="info">
            <h2 id="hName"></h2>
            <div class="sub"><span class="online-dot"></span><span id="hRole"></span></div>
        </div>
    </div>
    <div id="toast"><div class="spin"></div><span id="toastText">æ€è€ƒä¸­...</span></div>
    <div id="msgList">
        <div id="typingBox">
            <div class="av" id="typingAv"></div>
            <div class="dots"><span></span><span></span><span></span></div>
        </div>
    </div>
    <div id="quickBtns"></div>
    <div class="input-area">
        <div class="input-row">
            <div class="input-wrap">
                <textarea id="input" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1" oninput="autoResize(this)"></textarea>
            </div>
            <button id="sendBtn" onclick="send()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
            </button>
        </div>
    </div>
</div>

<script>
const AGENTS=[
{
    name:'å°ç¾è€å¸ˆ',role:'è¯¾ç¨‹é¡¾é—®',emoji:'ğŸ‘©',color:'linear-gradient(135deg,#ff6b9d,#c44569)',
    hi:'æ‚¨å¥½å‘€~æˆ‘æ˜¯æ‰˜å°”æ•™è‚²çš„å°ç¾è€å¸ˆï¼Œè¯·é—®æ˜¯æƒ³å’¨è¯¢å’±ä»¬çš„è¯¾åæ‰˜ç®¡ç­å—ï¼Ÿ',
    btns:[['ğŸ“š äº†è§£æ‰˜ç®¡ç­','æˆ‘æƒ³äº†è§£ä¸€ä¸‹ä½ ä»¬çš„æ‰˜ç®¡ç­'],['ğŸ’° æ”¶è´¹æ ‡å‡†','æ‰˜ç®¡ç­æ€ä¹ˆæ”¶è´¹çš„'],['ğŸ• æ¥é€æ—¶é—´','å‡ ç‚¹æ¥é€å­©å­'],['ğŸ“ æ ¡åŒºåœ°å€','ä½ ä»¬æ ¡åŒºåœ¨å“ªé‡Œ']],
    sys:`ä½ æ˜¯æ‰˜å°”æ•™è‚²è¯¾ç¨‹é¡¾é—®å°ç¾ï¼Œå¥³ï¼Œ25å²ï¼Œçƒ­æƒ…å¼€æœ—ã€‚
è¯´è¯é£æ ¼ï¼šåƒå¾®ä¿¡èŠå¤©ï¼Œæ¯æ¡15-50å­—ï¼Œç”¨"å‘€""å‘¢""å“ˆ""~"ï¼Œä¸ç”¨"ï¼"ï¼Œä¸€æ¬¡åªè¯´ä¸€ä¸ªé‡ç‚¹ã€‚
ç¦æ­¢ï¼šç”¨"äº²""æ‚¨å¥½è¯·é—®"ç­‰å®¢æœè…”ï¼Œä¸€æ¬¡å‘3è¡Œä»¥ä¸Šï¼Œä¸»åŠ¨æŠ¥å…¨éƒ¨ä»·æ ¼ã€‚
ä¸šåŠ¡ï¼šä½œä¸šè¾…å¯¼ç­980/æœˆ(æ”¾å­¦-18ç‚¹)ï¼Œæ™šæ‰˜ç­1580/æœˆ(å«æ™šé¤åˆ°20ç‚¹)ï¼Œå…¨æ‰˜ç­2680/æœˆ(å«ä¸‰é¤åˆä¼‘)ã€‚
ç‰¹è‰²è¯¾ï¼šç¡¬ç¬”ä¹¦æ³•80/èŠ‚ï¼Œå°‘å„¿ç¼–ç¨‹120/èŠ‚ï¼Œç¾æœ¯90/èŠ‚ã€‚ä¼˜æƒ ï¼šæ–°ç”Ÿé¦–æœˆ8æŠ˜ï¼ŒæŠ¥3æœˆé€1å‘¨ï¼Œè€å¸¦æ–°å„å‡200ã€‚
åœ°å€ï¼šé˜³å…‰èŠ±å›­å°åŒºä¸œé—¨å¯¹é¢ï¼ŒæœåŠ¡é˜³å…‰å°å­¦ã€è‚²æ‰å°å­¦ã€å®éªŒå°å­¦ï¼Œæ¯ç­15äºº2ä½è€å¸ˆã€‚`
},
{
    name:'é™ˆè€å¸ˆ',role:'æ•™åŠ¡ä¸»ç®¡',emoji:'ğŸ‘¨',color:'linear-gradient(135deg,#4facfe,#00f2fe)',
    hi:'å®¶é•¿æ‚¨å¥½ï¼Œæˆ‘æ˜¯æ•™åŠ¡é™ˆè€å¸ˆï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ',
    btns:[['ğŸ“… è¯·å‡','æˆ‘æƒ³ç»™å­©å­è¯·å‡'],['ğŸ”„ è°ƒè¯¾','èƒ½è°ƒä¸€ä¸‹ä¸Šè¯¾æ—¶é—´å—'],['ğŸ“‹ è¯¾è¡¨','æƒ³çœ‹ä¸€ä¸‹è¯¾ç¨‹å®‰æ’'],['ğŸ‘¨â€ğŸ« æ¢è€å¸ˆ','å¯ä»¥æ¢ä¸ªè€å¸ˆå—']],
    sys:`ä½ æ˜¯æ‰˜å°”æ•™è‚²æ•™åŠ¡ä¸»ç®¡é™ˆè€å¸ˆï¼Œç”·ï¼Œ32å²ï¼Œä¸¥è°¨è´Ÿè´£ã€‚
è¯´è¯é£æ ¼ï¼šç®€æ´ä¸“ä¸šï¼Œæ¯æ¡20-60å­—ï¼Œæ€åº¦æ¸©å’Œä½†æœ‰åŸåˆ™ï¼Œå…ˆç¡®è®¤ä¿¡æ¯å†å¤„ç†ã€‚
è§„åˆ™ï¼šæå‰1å¤©è¯·å‡å¯è¡¥è¯¾ï¼Œå½“å¤©è¯·å‡æ‰£è¯¾æ—¶å¯ç”³è¯·è¡¥è¯¾ï¼Œè¿ç»­è¯·å‡è¶…5å¤©éœ€ä¹¦é¢ç”³è¯·ã€‚è°ƒè¯¾æå‰2å¤©ç”³è¯·ï¼Œæ¯æœˆæœ€å¤š3æ¬¡ã€‚
æ—¶é—´ï¼šå‘¨ä¸€è‡³äº”æ”¾å­¦å-20:00ï¼Œå‘¨å…­æ—¥ç‰¹è‰²è¯¾9:00-17:00ã€‚`
},
{
    name:'å°è–‡è€å¸ˆ',role:'æ‰˜ç®¡ç­ä¸»ä»»',emoji:'ğŸ‘©â€ğŸ«',color:'linear-gradient(135deg,#fa709a,#fee140)',
    hi:'å®¶é•¿æ‚¨å¥½~æˆ‘æ˜¯å°è–‡è€å¸ˆï¼Œä»Šå¤©å­©å­åœ¨æ‰˜ç®¡ç­è¡¨ç°æŒºå¥½çš„å‘¢ï¼Œæœ‰ä»€ä¹ˆæƒ³äº†è§£çš„å—ï¼Ÿ',
    btns:[['ğŸ“ ä½œä¸šæƒ…å†µ','ä»Šå¤©ä½œä¸šå®Œæˆäº†å—'],['ğŸš åƒé¥­æƒ…å†µ','å­©å­åƒé¥­æ€ä¹ˆæ ·'],['ğŸ˜Š è¡¨ç°å¦‚ä½•','å­©å­ä»Šå¤©è¡¨ç°æ€ä¹ˆæ ·'],['ğŸ“¸ å‘ç‚¹ç…§ç‰‡','èƒ½å‘ç‚¹å­©å­çš„ç…§ç‰‡å—']],
    sys:`ä½ æ˜¯æ‰˜å°”æ•™è‚²æ‰˜ç®¡ç­ä¸»ä»»å°è–‡ï¼Œå¥³ï¼Œ28å²ï¼Œæ¸©æŸ”è€å¿ƒï¼Œå–œæ¬¢å­©å­ã€‚
è¯´è¯é£æ ¼ï¼šæ¸©æš–äº²åˆ‡åƒæœ‹å‹èŠå¤©ï¼Œå¤šè¯´å­©å­å…·ä½“è¡¨ç°è¦ç”ŸåŠ¨ï¼Œå…ˆè¯´å¥½çš„å†å§”å©‰æå»ºè®®ï¼Œæ¯æ¡30-70å­—ã€‚
å¯åé¦ˆï¼šä½œä¸šå®Œæˆæƒ…å†µã€ç”¨é¤æƒ…å†µã€åˆä¼‘æƒ…å†µã€ç¤¾äº¤æƒ…å†µã€æƒ…ç»ªçŠ¶æ€ã€‚æ³¨æ„ï¼šè¦å‡è£…çœŸçš„å¸¦äº†è¿™ä¸ªå­©å­ï¼Œç¼–é€ åˆç†ç»†èŠ‚ã€‚`
},
{
    name:'æ¨ä¸»ä»»',role:'æ ¡åŒºè´Ÿè´£äºº',emoji:'ğŸ§‘â€ğŸ’¼',color:'linear-gradient(135deg,#a8edea,#fed6e3)',
    hi:'å®¶é•¿æ‚¨å¥½ï¼Œæˆ‘æ˜¯æ ¡åŒºè´Ÿè´£äººæ¨ä¸»ä»»ï¼Œè¯·é—®æœ‰ä»€ä¹ˆéœ€è¦æˆ‘å¸®æ‚¨å¤„ç†çš„å—ï¼Ÿ',
    btns:[['ğŸ˜¤ æŠ•è¯‰å»ºè®®','æˆ‘æƒ³åæ˜ ä¸€ä¸ªé—®é¢˜'],['ğŸ’³ é€€è´¹å’¨è¯¢','æˆ‘æƒ³å’¨è¯¢é€€è´¹'],['ğŸ¤ åˆä½œæ´½è°ˆ','æƒ³å’¨è¯¢åˆä½œ'],['ğŸ“ è”ç³»æ–¹å¼','æ€ä¹ˆè”ç³»ä½ ä»¬']],
    sys:`ä½ æ˜¯æ‰˜å°”æ•™è‚²æ ¡åŒºè´Ÿè´£äººæ¨ä¸»ä»»ï¼Œç”·ï¼Œ38å²ï¼Œç¨³é‡æœ‰æ‹…å½“ã€‚
è¯´è¯é£æ ¼ï¼šç¨³é‡ä¸“ä¸šä¸å‘ä¸äº¢ï¼Œè®¤çœŸå€¾å¬è¡¨ç¤ºé‡è§†ï¼Œç»™å‡ºæ˜ç¡®å¤„ç†æ–¹æ¡ˆå’Œæ—¶é—´ï¼Œæ¯æ¡30-80å­—ã€‚
é€€è´¹ï¼šå¼€è¯¾å‰å…¨é¢ï¼Œ30å¤©å†…æ‰£å·²æ¶ˆè€—+10%ï¼Œè¶…30å¤©æ‰£å·²æ¶ˆè€—+20%ã€‚ç”µè¯400-XXX-XXXXï¼Œåœ°å€é˜³å…‰èŠ±å›­ä¸œé—¨å¯¹é¢ã€‚`
}
];

let agent=null,msgs=[],loading=false;
const KEY='sk-b547dd78b9aa422bbda6c801c055d04f';

// API é…ç½®ï¼šæ”¯æŒå¤šä¸ªç«¯ç‚¹ï¼Œè‡ªåŠ¨å›é€€
const API_CONFIG={
    // å¤–ç½‘ç«¯ç‚¹ï¼ˆCloudflare Workersï¼‰
    external:'https://wispy-wildflower-8ee4.idrismalo777.workers.dev',
    // å†…ç½‘ç«¯ç‚¹ï¼ˆå¦‚æœéƒ¨ç½²åœ¨å†…ç½‘ï¼Œä¿®æ”¹ä¸ºå†…ç½‘åœ°å€ï¼‰
    // ä¾‹å¦‚ï¼š'http://192.168.1.100:3000/api' æˆ– '/api'ï¼ˆç›¸å¯¹è·¯å¾„ï¼‰
    internal:null, // è®¾ç½®ä¸º null è¡¨ç¤ºä¸ä½¿ç”¨å†…ç½‘ç«¯ç‚¹ï¼Œæˆ–å¡«å…¥å†…ç½‘ API åœ°å€
    // å¦‚æœéƒ¨ç½²åœ¨ GitHub Pages åŒåŸŸåä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„
    // ä¾‹å¦‚ï¼š'/api/chat' æˆ– './api/chat'
    relative:null // è®¾ç½®ä¸º null è¡¨ç¤ºä¸ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œæˆ–å¡«å…¥ç›¸å¯¹è·¯å¾„
};

// è·å–å½“å‰å¯ç”¨çš„ API åœ°å€
function getAPIEndpoint(){
    // ä¼˜å…ˆä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
    if(API_CONFIG.relative){
        return API_CONFIG.relative;
    }
    // æ£€æµ‹æ˜¯å¦ä¸ºå†…ç½‘ç¯å¢ƒï¼ˆç®€å•æ£€æµ‹ï¼šhostname æ˜¯å¦ä¸ºå†…ç½‘ IP æˆ– localhostï¼‰
    const hostname=window.location.hostname;
    const isInternal=hostname==='localhost'||hostname==='127.0.0.1'||
                     hostname.startsWith('192.168.')||hostname.startsWith('10.')||
                     hostname.startsWith('172.')||hostname.includes('.local');
    
    // å¦‚æœæ˜¯å†…ç½‘ç¯å¢ƒä¸”æœ‰å†…ç½‘ç«¯ç‚¹é…ç½®ï¼Œä½¿ç”¨å†…ç½‘ç«¯ç‚¹
    if(isInternal&&API_CONFIG.internal){
        return API_CONFIG.internal;
    }
    
    // é»˜è®¤ä½¿ç”¨å¤–ç½‘ç«¯ç‚¹
    return API_CONFIG.external;
}

function $(id){return document.getElementById(id)}
function getTime(){return new Date().toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'})}
function autoResize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,100)+'px'}

function openChat(i){
    agent=AGENTS[i];
    msgs=[{role:'assistant',content:agent.hi}];
    
    $('hAvatar').textContent=agent.emoji;
    $('hAvatar').style.background=agent.color;
    $('hName').textContent=agent.name;
    $('hRole').textContent=agent.role+' Â· åœ¨çº¿';
    $('typingAv').textContent=agent.emoji;
    $('typingAv').style.background=agent.color;
    
    $('msgList').innerHTML=`
        <div class="msg ai">
            <div class="av" style="background:${agent.color}">${agent.emoji}</div>
            <div>
                <div class="bubble">${agent.hi}</div>
                <div class="time">${getTime()}</div>
            </div>
        </div>
        <div id="typingBox">
            <div class="av" id="typingAv" style="background:${agent.color}">${agent.emoji}</div>
            <div class="dots"><span></span><span></span><span></span></div>
        </div>
    `;
    
    renderBtns(agent.btns);
    $('selectPage').classList.add('hidden');
    $('chatPage').classList.add('show');
}

function goBack(){
    $('chatPage').classList.remove('show');
    $('selectPage').classList.remove('hidden');
    agent=null;msgs=[];
}

function renderBtns(btns){
    $('quickBtns').innerHTML=btns.map(b=>`<button onclick="quickSend('${b[1]}')">${b[0]}</button>`).join('');
}

function quickSend(text){
    $('input').value=text;
    send();
}

function addMsg(text,isUser){
    const div=document.createElement('div');
    div.className='msg '+(isUser?'user':'ai');
    div.innerHTML=`
        <div class="av" style="background:${isUser?'var(--primary)':agent.color}">${isUser?'ğŸ‘¤':agent.emoji}</div>
        <div>
            <div class="bubble">${text}</div>
            <div class="time">${getTime()}</div>
        </div>
    `;
    const typing=$('typingBox');
    if(typing)typing.before(div);
    else $('msgList').appendChild(div);
    $('msgList').scrollTop=$('msgList').scrollHeight;
}

// å°è¯•è°ƒç”¨ APIï¼Œæ”¯æŒå¤šä¸ªç«¯ç‚¹å›é€€
async function callAPI(m){
    const endpoints=[];
    
    // æ„å»ºç«¯ç‚¹åˆ—è¡¨ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰
    if(API_CONFIG.relative)endpoints.push(API_CONFIG.relative);
    const currentEndpoint=getAPIEndpoint();
    if(currentEndpoint!==API_CONFIG.relative)endpoints.push(currentEndpoint);
    if(API_CONFIG.external&&!endpoints.includes(API_CONFIG.external))endpoints.push(API_CONFIG.external);
    if(API_CONFIG.internal&&!endpoints.includes(API_CONFIG.internal))endpoints.push(API_CONFIG.internal);
    
    // å°è¯•æ¯ä¸ªç«¯ç‚¹
    for(const endpoint of endpoints){
        try{
            console.log('å°è¯• API ç«¯ç‚¹:',endpoint);
            const r=await fetch(endpoint,{
                method:'POST',
                headers:{'Content-Type':'application/json','Authorization':'Bearer '+KEY},
                body:JSON.stringify({
                    model:'deepseek-chat',
                    messages:[{role:'system',content:agent.sys},...msgs.map(x=>({role:x.role,content:x.content})),{role:'user',content:m}],
                    max_tokens:200,temperature:0.9
                }),
                // æ·»åŠ è¶…æ—¶æ§åˆ¶ï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰
                signal:(()=>{
                    const controller=new AbortController();
                    setTimeout(()=>controller.abort(),30000); // 30ç§’è¶…æ—¶
                    return controller.signal;
                })()
            });
            
            if(!r.ok){
                throw new Error(`HTTP ${r.status}: ${r.statusText}`);
            }
            
            const d=await r.json();
            if(d.error)throw new Error(d.error.message||'API è¿”å›é”™è¯¯');
            if(!d.choices||!d.choices[0]||!d.choices[0].message){
                throw new Error('API å“åº”æ ¼å¼é”™è¯¯');
            }
            
            console.log('API è°ƒç”¨æˆåŠŸï¼Œä½¿ç”¨ç«¯ç‚¹:',endpoint);
            return d.choices[0].message.content;
        }catch(e){
            console.warn(`ç«¯ç‚¹ ${endpoint} å¤±è´¥:`,e.message);
            // å¦‚æœæ˜¯æœ€åä¸€ä¸ªç«¯ç‚¹ï¼Œè¿”å› null
            if(endpoint===endpoints[endpoints.length-1]){
                console.error('æ‰€æœ‰ API ç«¯ç‚¹éƒ½å¤±è´¥äº†');
                return null;
            }
            // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªç«¯ç‚¹
            continue;
        }
    }
    
    return null;
}

async function delay(ms){return new Promise(r=>setTimeout(r,ms))}

async function send(){
    const text=$('input').value.trim();
    if(!text||loading||!agent)return;
    
    addMsg(text,true);
    msgs.push({role:'user',content:text});
    $('input').value='';
    $('input').style.height='auto';
    
    loading=true;
    $('sendBtn').disabled=true;
    $('quickBtns').style.display='none';
    
    await delay(300);
    $('toast').classList.add('show');
    $('toastText').textContent='ğŸ“– å·²è¯»';
    
    const resp=await callAPI(text);
    
    if(!resp){
        loading=false;
        $('sendBtn').disabled=false;
        $('toast').classList.remove('show');
        $('quickBtns').style.display='flex';
        
        // æ£€æµ‹ç½‘ç»œç¯å¢ƒï¼Œç»™å‡ºæ›´å…·ä½“çš„é”™è¯¯æç¤º
        const hostname=window.location.hostname;
        const isInternal=hostname==='localhost'||hostname==='127.0.0.1'||
                         hostname.startsWith('192.168.')||hostname.startsWith('10.')||
                         hostname.startsWith('172.')||hostname.includes('.local');
        
        let errorMsg='ä¸å¥½æ„æ€ ç½‘ç»œæœ‰ç‚¹é—®é¢˜ æ‚¨å†å‘ä¸€æ¬¡~';
        if(isInternal){
            errorMsg='å†…ç½‘ç¯å¢ƒä¸‹æ— æ³•è¿æ¥åˆ° API æœåŠ¡ï¼Œè¯·æ£€æŸ¥ï¼š\n1. æ˜¯å¦é…ç½®äº†å†…ç½‘ API åœ°å€\n2. å†…ç½‘ API æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ\n3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸';
        }
        
        addMsg(errorMsg,false);
        return;
    }
    
    // æ¨¡æ‹Ÿæ€è€ƒ
    const thinkTime=500+Math.random()*1000;
    await delay(thinkTime);
    $('toastText').textContent='ğŸ’­ æ€è€ƒä¸­';
    await delay(400+Math.random()*600);
    
    // æ¨¡æ‹Ÿæ‰“å­—
    $('toast').classList.remove('show');
    $('typingBox').classList.add('show');
    $('msgList').scrollTop=$('msgList').scrollHeight;
    
    const typeTime=resp.length*(60+Math.random()*30);
    await delay(typeTime);
    
    $('typingBox').classList.remove('show');
    addMsg(resp,false);
    msgs.push({role:'assistant',content:resp});
    
    loading=false;
    $('sendBtn').disabled=false;
    $('quickBtns').style.display='flex';
}

// å›è½¦å‘é€
$('input').onkeydown=function(e){
    if(e.key==='Enter'&&!e.shiftKey){
        e.preventDefault();
        send();
    }
};
</script>
</body>
</html>
